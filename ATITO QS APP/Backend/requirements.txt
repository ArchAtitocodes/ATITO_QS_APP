# backend/requirements.txt
"""
Python Dependencies for ATITO QS App Backend
Author: Eng. STEPHEN ODHIAMBO
"""

# Web Framework
fastapi==0.111.0
uvicorn[standard]==0.29.0
python-multipart==0.0.9

# Database
sqlalchemy==2.0.30
psycopg2-binary==2.9.9 # Stays the same, latest stable
alembic==1.13.1

# Authentication & Security
python-jose[cryptography]==3.3.0
passlib[bcrypt]==1.7.4
python-dotenv==1.0.1
pydantic-settings==2.2.1

# Redis & Celery
redis==5.0.4
celery[redis]==5.4.0

# File Processing
PyMuPDF==1.24.2
pdfplumber==0.11.0
ezdxf==1.4.1
ifcopenshell==0.8.0
Pillow==10.3.0
python-magic==0.4.27  # File type detection

# OCR
pytesseract==0.3.10
google-cloud-vision==3.7.2

# AI/ML/CV
torch==2.3.0
torchvision==0.18.0
ultralytics==8.2.28
opencv-python==4.9.0.80
numpy==1.26.4
scipy==1.13.0

# NLP (optional, for future enhancements)
spacy==3.7.5

# Web Scraping
selenium==4.21.0
beautifulsoup4==4.12.2
lxml==5.2.2
httpx==0.27.0

# Report Generation
openpyxl==3.1.3
pandas==2.2.2
reportlab==4.2.0
xlsxwriter==3.2.0

# M-Pesa Integration
requests==2.31.0 # Stays the same, latest stable

# Utilities
python-dateutil==2.8.2
pytz==2024.1

# Testing
pytest==8.2.1
pytest-asyncio==0.23.7
pytest-cov==5.0.0

# Development
black==24.4.2
flake8==7.0.0
mypy==1.10.0

# Monitoring
sentry-sdk==2.0.1


# ============================================
# backend/Dockerfile
# ============================================
"""
Multi-stage Docker build for ATITO QS Backend
"""

FROM python:3.11-slim as base

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    tesseract-ocr \
    tesseract-ocr-eng \
    libmagic1 \
    chromium \
    chromium-driver \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Create uploads directory
RUN mkdir -p /app/uploads

# Expose port
EXPOSE 8000

# Run application
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]


# ============================================
# docker-compose.yml
# ============================================
version: '3.8'

services:
  backend:
    build: ./backend
    container_name: atito-backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/atito_db
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    env_file:
      - ./backend/.env
    volumes:
      - ./backend:/app
      - uploads:/app/uploads
    depends_on:
      - db
      - redis
    restart: unless-stopped

  db:
    image: postgres:15-alpine
    container_name: atito-db
    environment:
      - POSTGRES_DB=atito_db
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: atito-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

  celery_worker:
    build: ./backend
    container_name: atito-celery-worker
    command: celery -A app.workers.celery_app worker --loglevel=info
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/atito_db
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    env_file:
      - ./backend/.env
    volumes:
      - ./backend:/app
      - uploads:/app/uploads
    depends_on:
      - db
      - redis
    restart: unless-stopped

  celery_beat:
    build: ./backend
    container_name: atito-celery-beat
    command: celery -A app.workers.celery_app beat --loglevel=info
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/atito_db
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    env_file:
      - ./backend/.env
    volumes:
      - ./backend:/app
    depends_on:
      - db
      - redis
    restart: unless-stopped

  frontend:
    build: ./frontend
    container_name: atito-frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://backend:8000
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  uploads:


# ============================================
# backend/.env.example
# ============================================
# Application
APP_NAME="ATITO QS App"
DEBUG=False
ENVIRONMENT=production

# Security
SECRET_KEY=your-secret-key-min-32-characters-long
ALGORITHM=HS256

# Database (Supabase PostgreSQL)
DATABASE_URL=postgresql://user:password@db.supabase.co:5432/postgres

# Redis
REDIS_URL=redis://localhost:6379/0

# Google Vision API
GOOGLE_APPLICATION_CREDENTIALS=/path/to/credentials.json
GOOGLE_VISION_API_KEY=your-api-key

# M-Pesa Configuration
MPESA_CONSUMER_KEY=your-consumer-key
MPESA_CONSUMER_SECRET=your-consumer-secret
MPESA_PASSKEY=your-passkey
MPESA_SHORTCODE=174379
MPESA_CALLBACK_URL=https://your-domain.com/api/mpesa/callback
MPESA_SAFARICOM_PHONE=+254701453230
MPESA_AIRTEL_PHONE=+254102015805

# File Storage
UPLOAD_DIR=./uploads
MAX_UPLOAD_SIZE=104857600

# AI/ML
MODEL_PATH=models/yolov8n.pt
AI_CONFIDENCE_THRESHOLD=0.80
OCR_CONFIDENCE_THRESHOLD=0.80

# Email (Optional)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASSWORD=your-app-password

# Monitoring
SENTRY_DSN=your-sentry-dsn


# ============================================
# backend/app/main.py
# ============================================
"""
ATITO QS App - FastAPI Main Application
Author: Eng. STEPHEN ODHIAMBO
"""

from fastapi import FastAPI, Request, status
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.trustedhost import TrustedHostMiddleware
from fastapi.responses import JSONResponse
from fastapi.exceptions import RequestValidationError
from contextlib import asynccontextmanager
import time

from app.config import settings
from app.database import engine, Base
from app.api import auth, projects, boq, bbs, uploads, reports, sitelogs, expenses, payments

# Import all models to ensure they're registered
from app.models import *


@asynccontextmanager
async def lifespan(app: FastAPI):
    """Lifecycle events"""
    # Startup
    print("Starting ATITO QS App...")
    print(f"Environment: {settings.ENVIRONMENT}")
    print(f"Database: Connected")
    
    # Create tables
    Base.metadata.create_all(bind=engine)
    print("Database tables created/verified")
    
    yield
    
    # Shutdown
    print("Shutting down ATITO QS App...")


# Create FastAPI application
app = FastAPI(
    title=settings.APP_NAME,
    version=settings.APP_VERSION,
    description="AI-Powered Quantity Surveying and Construction Management System",
    lifespan=lifespan
)

# CORS Middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"] if settings.DEBUG else ["https://your-frontend-domain.com"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Trusted Host Middleware (security)
if not settings.DEBUG:
    app.add_middleware(
        TrustedHostMiddleware,
        allowed_hosts=["your-domain.com", "*.your-domain.com"]
    )


# Request timing middleware
@app.middleware("http")
async def add_process_time_header(request: Request, call_next):
    start_time = time.time()
    response = await call_next(request)
    process_time = time.time() - start_time
    response.headers["X-Process-Time"] = str(process_time)
    return response


# Global exception handlers
@app.exception_handler(RequestValidationError)
async def validation_exception_handler(request: Request, exc: RequestValidationError):
    return JSONResponse(
        status_code=status.HTTP_422_UNPROCESSABLE_ENTITY,
        content={"detail": exc.errors(), "body": exc.body}
    )


@app.exception_handler(Exception)
async def general_exception_handler(request: Request, exc: Exception):
    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content={"detail": "Internal server error", "error": str(exc)}
    )


# Include routers
app.include_router(auth.router)
# app.include_router(projects.router)  # To be implemented
# app.include_router(boq.router)  # To be implemented
# app.include_router(bbs.router)  # To be implemented
# app.include_router(uploads.router)  # To be implemented
# app.include_router(reports.router)  # To be implemented
# app.include_router(sitelogs.router)  # To be implemented
# app.include_router(expenses.router)  # To be implemented
# app.include_router(payments.router)  # To be implemented


# Root endpoint
@app.get("/")
async def root():
    return {
        "message": "Welcome to ATITO QS App API",
        "version": settings.APP_VERSION,
        "author": "Eng. STEPHEN ODHIAMBO",
        "description": "AI-Powered Quantity Surveying & Construction Management",
        "docs": "/docs",
        "health": "/health"
    }


# Health check endpoint
@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "environment": settings.ENVIRONMENT,
        "version": settings.APP_VERSION
    }


# API Info endpoint
@app.get("/api/info")
async def api_info():
    return {
        "app_name": settings.APP_NAME,
        "version": settings.APP_VERSION,
        "environment": settings.ENVIRONMENT,
        "features": {
            "file_upload": ["PDF", "DWG", "DXF", "IFC", "JPEG", "PNG"],
            "ai_processing": True,
            "ocr": ["Google Vision API", "Tesseract"],
            "outputs": ["BoQ", "BBS", "Reports", "Excel", "PDF"],
            "payments": ["M-Pesa", "Airtel Money"],
            "collaboration": True,
            "offline_support": True
        },
        "subscription_plans": {
            "free": {
                "trial_days": settings.FREE_TRIAL_DAYS,
                "max_projects": settings.FREE_MAX_PROJECTS,
                "max_floors": settings.FREE_MAX_FLOORS
            },
            "pro": {
                "monthly_cost": f"KES {settings.PRO_MONTHLY_COST}",
                "max_floors": settings.PRO_MAX_FLOORS
            },
            "business": {
                "monthly_cost": f"KES {settings.BUSINESS_MONTHLY_COST}",
                "max_floors": settings.BUSINESS_MAX_FLOORS
            }
        },
        "author": "Eng. STEPHEN ODHIAMBO - Civil Engineer & AI Engineer"
    }


if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        "app.main:app",
        host="0.0.0.0",
        port=8000,
        reload=settings.DEBUG
    )


# ============================================
# .gitignore
# ============================================
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
venv/
env/
ENV/

# Environment variables
.env
.env.local
.env.production

# Database
*.db
*.sqlite3

# Uploads
uploads/
*.pdf
*.dwg
*.dxf
*.ifc

# AI Models (too large for git)
models/*.pt
models/*.h5
models/*.pkl

# IDE
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Logs
*.log
logs/

# Testing
.coverage
.pytest_cache/
htmlcov/

# Build
dist/
build/
*.egg-info/

# Node (frontend)
node_modules/
.next/
out/
.turbo

# Docker
.docker/


# ============================================
# README.md
# ============================================
# ATITO QS App

**AI-Powered Quantity Surveying & Construction Management System**

*Built specifically for the Kenyan construction market*

## üèóÔ∏è Project Overview

ATITO QS App is a comprehensive, production-ready system that automates quantity surveying and construction management using advanced AI/ML techniques. It processes architectural drawings (PDF, DWG, IFC) and generates accurate Bill of Quantities (BoQ), Bar Bending Schedules (BBS), and comprehensive reports.

### Key Features

- ‚úÖ **Multi-Format Drawing Support**: PDF, DWG, DXF, IFC, JPEG, PNG
- ‚úÖ **AI-Powered Analysis**: YOLOv8 for element detection
- ‚úÖ **Dual OCR Engine**: Google Vision API + Tesseract fallback
- ‚úÖ **Automatic BoQ Generation**: Based on KESMM4 standards
- ‚úÖ **BS 8666 Compliant BBS**: Automated reinforcement scheduling
- ‚úÖ **Real-Time Material Pricing**: Web scraping from IQSK, NCA, KIPPRA
- ‚úÖ **M-Pesa Integration**: Seamless mobile money payments
- ‚úÖ **Offline-First**: Progressive Web App with IndexedDB
- ‚úÖ **Collaboration Tools**: Role-based access, comments, site logs
- ‚úÖ **Comprehensive Reports**: Excel, PDF, CSV exports

## üë®‚Äçüíº Author

**Eng. STEPHEN ODHIAMBO**  
*Civil Engineer & AI Engineer*

## üöÄ Quick Start

### Prerequisites

- Python 3.11+
- PostgreSQL 15+
- Redis 7+
- Node.js 18+ (for frontend)
- Docker & Docker Compose (recommended)

### Installation

1. Clone the repository
```bash
git clone https://github.com/yourusername/atito-qs-app.git
cd atito-qs-app
```

2. Set up environment variables
```bash
cp backend/.env.example backend/.env
# Edit .env with your configuration
```

3. Run with Docker Compose
```bash
docker-compose up -d
```

4. Initialize database
```bash
docker-compose exec backend python scripts/init_db.py
docker-compose exec backend python scripts/seed_materials.py
```

5. Access the application
- Frontend: http://localhost:3000
- Backend API: http://localhost:8000
- API Docs: http://localhost:8000/docs

## üìä Subscription Plans

| Plan | Price | Projects | Max Floors | Features |
|------|-------|----------|------------|----------|
| **Free** | Trial (30 days) | 1 | 1 floor | 50 tokens/day |
| **Pro** | KES 500/month | 8/day | 5 floors | Full features |
| **Business** | KES 2000/month | Unlimited | 10 floors | Priority support |

## üèóÔ∏è System Architecture

```
Frontend (Next.js) ‚Üí API (FastAPI) ‚Üí Database (PostgreSQL)
                          ‚Üì
                    Celery Workers ‚Üí Redis
                          ‚Üì
                    AI/ML Pipeline (YOLOv8, OCR)
                          ‚Üì
                    Report Generation
```

## üìù License

Proprietary - ¬© 2025 Eng. STEPHEN ODHIAMBO

## üìß Contact

For inquiries: stephenodhiambo008@gmail.com

---

**Built with ‚ù§Ô∏è for the Kenyan construction industry**
